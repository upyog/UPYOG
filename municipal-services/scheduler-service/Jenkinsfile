pipeline {
  agent any

  environment {
    REGISTRY = "docker.io"
    REPO = "upyoguddhp"
  }

  stages {

    stage('Checkout') {
      steps {
        git url: 'https://github.com/upyoguddhp/UPYOG.git',
            branch: 'master',
            credentialsId: 'git-creds'
      }
    }

    stage('Build Scheduler Service') {
      steps {
        dir('municipal-services/scheduler-service') {
          sh 'mvn clean package -DskipTests'
        }
      }
    }

    stage('Docker Build & Push') {
      steps {
        script {
          docker.withRegistry("https://${env.REGISTRY}", "docker-creds") {
            sh """
              cd municipal-services/scheduler-service
              docker build -t ${env.REPO}/scheduler-service -f build/maven/Dockerfile .
              docker push ${env.REPO}/scheduler-service
            """
          }
        }
      }
    }

  }
}
