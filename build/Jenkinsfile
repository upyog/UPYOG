pipeline {
  agent any

  environment {
    REGISTRY = "docker.io"
    REPO = "upyoguddhp"
  }

  parameters {

    activeChoiceParam('SERVICE_NAME') {
      description('Select service to build')
      choiceType('SINGLE_SELECT')

      groovyScript("""
          @Grab('org.yaml:snakeyaml:1.33')
          import org.yaml.snakeyaml.*

          def url = new URL("https://raw.githubusercontent.com/upyoguddhp/UPYOG/master/build/build-config.yml")
          def yamlText = url.text
          def data = new Yaml().load(yamlText)

          return data.config.collect { it.build[0]['image-name'] }
      """)
    }

    string(
      name: 'SEMVER',
      defaultValue: '0.0.1',
      description: 'Semantic Version (e.g., 0.0.1)'
    )
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: 'master',
            url: 'https://github.com/upyoguddhp/UPYOG.git',
            credentialsId: 'git-creds'
      }
    }

    stage("Read YAML") {
      steps {
        script {
          config = readYaml file: "build/build-config.yml"
        }
      }
    }

    stage("Find Service Entry") {
      steps {
        script {
          entry = config.config.find { svc ->
            svc.build.any { it['image-name'] == params.SERVICE_NAME }
          }

          if(!entry) {
            error "Service ${params.SERVICE_NAME} not found in build-config.yml"
          }

          targets = entry.build
          echo "Selected: ${targets}"
        }
      }
    }

    stage("Build & Push") {
      steps {
        script {

          def commit = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
          def buildNo = env.BUILD_NUMBER
          def tag = "v${params.SEMVER}-${commit}-${buildNo}"

          withCredentials([usernamePassword(credentialsId: 'docker-creds',
                    usernameVariable: 'USER',
                    passwordVariable: 'PASS')]) {

              sh """
                echo $PASS | docker login -u $USER --password-stdin
              """

              targets.each { t ->

                  def workDir = t['work-dir']
                  def image = "${REGISTRY}/${REPO}/${t['image-name']}:${tag}"
                  def dockerfile = t['dockerfile'] ?: "build/maven/Dockerfile"

                  echo "Building ${image}"

                  sh """
                    docker build \
                      --build-arg WORK_DIR=${workDir} \
                      -f ${dockerfile} \
                      -t ${image} .
                    docker push ${image}
                  """
              }
          }
        }
      }
    }
  }

  post {
    success { echo "Build Success" }
    failure { echo "Build Failed" }
  }
}
